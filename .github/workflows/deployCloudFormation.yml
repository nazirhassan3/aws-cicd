name: Deploy APIs with Multi-Stage

on:
  push:
    branches: nazir
    paths:
      - "src/cloudFormationTemplates/*.yaml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Detect Changed Templates
        id: detect
        run: |
          PREVIOUS_COMMIT=${{ github.event.before }}
          if [ -z "$PREVIOUS_COMMIT" ] || ! git rev-parse --verify "$PREVIOUS_COMMIT" >/dev/null 2>&1; then
            PREVIOUS_COMMIT=$(git rev-parse HEAD^ || echo "")
          fi

          echo "Comparing $PREVIOUS_COMMIT with ${{ github.sha }}"

          if [ -z "$PREVIOUS_COMMIT" ]; then
            CHANGED_FILES=$(git ls-files | grep '^cloudFormationTemplates/.*\.yaml$' || true)
          else
            CHANGED_FILES=$(git diff --name-only $PREVIOUS_COMMIT ${{ github.sha }} | grep '^cloudFormationTemplates/.*\.yaml$' || true)
          fi

          # Use basename instead of cut to extract the file names.
          CHANGED_TEMPLATES=$(echo "$CHANGED_FILES" | xargs -n 1 basename | sort -u | jq -R -s -c 'split("\n")[:-1]')

          echo "Detected changed TEMPLATES: $CHANGED_TEMPLATES"
          echo "::set-output name=files::$CHANGED_TEMPLATES"
          # echo "TEMPLATES=$CHANGED_TEMPLATES" >> "$GITHUB_OUTPUT"

      - name: Deploy Changed CF Templates
        if: steps.detect.outputs.files != ''
        run: |
          files="${{ steps.cffiles.outputs.files }}"
          echo "Deploying the following CloudFormation templates:"
          echo "$files"
          for file in $files; do
            # Construct a stack name from the template file name (without extension)
            stackName=$(basename "$file" .yaml)
            echo "Deploying template: $file to stack: $stackName"
            aws cloudformation deploy \
              --stack-name "$stackName" \
              --template-file "$file" \
              --capabilities CAPABILITY_NAMED_IAM \
              --region us-east-1
          done

      - name: No CF Templates Changed
        if: steps.cffiles.outputs.files == ''
        run: echo "No CloudFormation template changes detected. Skipping deployment."
